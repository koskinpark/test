<?php
function phonebook_menu()
{
    $items['test/phonebook/add'] = array(
        'title' => 'Phonebook',
        'page callback' => 'drupal_get_form',
        'page arguments' => array('phonebook_form'),
        'access callback' => TRUE,
    );
    return $items;
}

function phonebook_form($form, &$form_state)
{
    $form['table'] = array(
        '#tree' => TRUE,
        '#theme' => 'tabular_form', // функция, с помощью которой мы будем придавать форме табличный вид
    );
    $form['table']['header'] = array(
        '#type' => 'value',
        '#value' => array(
            'Name of person',
            'Phone',
            'Tags',
            'Operations',
        ),
    );
    $form['table']['data']['phones'] = array(
         '#tree' => TRUE,
        '#prefix' => '<div id="phones-wrapper">',
        '#suffix' => '</div>',
    );
    if (empty($form_state['name_count'])) {
        $form_state['name_count'] = 1;
    }
    for ($i = 0; $i < $form_state['name_count']; $i++) {
        $form['table']['data']['phones'][$i]['name'] = array(
            '#type' => 'textfield',
            '#size' => 30,
        );
        $form['table']['data']['phones'][$i]['number'] = array(
            '#type' => 'textfield',
            '#size' => 30,
        );
        $form['table']['data']['phones'][$i]['tags'] = array(
            '#type' => 'textfield',
            '#size' => 30,
        );
        $form['table']['data']['phones'][$i]['add_more'] = array(
            '#type' => 'submit',
            '#value' => t('Add more'),
            '#submit' => array('phonebook_add_more_form_add'),
//            '#ajax' => array(
//                'wrapper' => 'phones-wrapper',
//                'callback' => 'phonebook_add_more_form_update',
//            ),
        );
    }
    $obj_phones = phonebook_get_phones_data();
    if (!empty($obj_phones)) {
        for ($i = 0; $i < count($obj_phones); $i++) {
//            $string_of_tags = substr($string_of_tags, 0, -2);
            $form['table']['data'][$obj_phones[$i]->idp]['name'] = array(
                '#type' => 'textfield',
                '#size' => 30,
                '#default_value' => $obj_phones[$i]->name,
            );
            $form['table']['data'][$obj_phones[$i]->idp]['number'] = array(
                '#type' => 'textfield',
                '#size' => 20,
                '#default_value' => $obj_phones[$i]->number,
            );
            $ids_of_tags = explode(',', $obj_phones[$i]->idtags);
            for ($j = 0; $j < count($ids_of_tags); $j++) {
                $tagname = phonebook_get_id_of_tag('tag', 'idt', $ids_of_tags[$j]);
                $form['table']['data'][$obj_phones[$i]->idp]['tags'][$j] = array(
                    '#type' => 'link',
                    '#title' => "   #$tagname",
                    '#href' => "/test/phonebook#$tagname",
                    '#suffix' => (($j+1) != count($ids_of_tags)) ? ', ' : '',
                );
            }
        }
    }



    $form['submit'] = array(
        '#type' => 'submit',
        '#value' => t('Save all values'),
    );

    return $form;
}

function phonebook_theme() {
    return array(
        'tabular_form' => array(
            'render element' => 'form',
        ),
    );
}

function theme_tabular_form($vars)
{
    $form = $vars['form'];
    $rows = array();
    if (!empty($form['data']['phones'])) {
        foreach (element_children($form['data']['phones']) as $key) {
            foreach (element_children($form['data']['phones'][$key]) as $name) {
                $rows[$key][] = drupal_render($form['data']['phones'][$key][$name]);
            }
        }
    }
    foreach (element_children($form['data']) as $key) {
        if ($key != 'phones') {
            foreach (element_children($form['data'][$key]) as $name) {
                $rows[$key][] = drupal_render($form['data'][$key][$name]);
            }
        }
    }
    return theme('table', array(
        'header' => $form['header']['#value'],
        'rows' => $rows,
    ));
}

function phonebook_add_more_form_add($form, &$form_state) {
    $form_state['name_count']++;
    $form_state['rebuild'] = TRUE;
}

function phonebook_add_more_form_update($form, $form_state) {
    return $form['table'];
}

function phonebook_form_validate($form, &$form_state)
{
    $amount_of_vars = $form_state['name_count'];
    for ($i = 0; $i < $amount_of_vars; $i++) {
        if (empty($form_state['values']['table']['data']['phones'][$i]['name'])) {
            form_set_error('name', t('Please, enter name of person'));
        } else {
            if (mb_strlen($form_state['values']['table']['data']['phones'][$i]['name']) > 35) {
                form_set_error('name', t('The name of person is too long'));
            }
        }
        if (empty($form_state['values']['table']['data']['phones'][$i]['number'])) {
            form_set_error('number', t('Please, enter phone number'));
        } else {
            if (mb_strlen($form_state['values']['table']['data']['phones'][$i]['number']) > 11) {
                form_set_error('number', t('The phone number is too long'));
            }
        }
        if (empty($form_state['values']['table']['data']['phones'][$i]['tags'])) {
            form_set_error('tags', t('Please, enter name of person'));
        } else {
            if (mb_strlen($form_state['values']['table']['data']['phones'][$i]['tags']) > 30) {
                form_set_error('tags', t('The number of tags is too large'));
            }
        }
    }
}

function phonebook_form_submit($form, &$form_state)
{
    $amount_of_vars = $form_state['name_count'];
//    for ($i = 0; $i < $amount_of_vars; $i++) {
//        $name = $form_state['values']['phones'][$i]['name'];
//        $number = $form_state['values']['phones'][$i]['number'];
//        $tags = array_diff(str_replace(' ', '', explode(",", $form_state['values']['phones'][$i]['tags'])), array(''));
//        $list_of_tags = '';
//        foreach ($tags as $tag) {
//            $id_of_tag = phonebook_get_id_of_tag('idt', 'tag', $tag);
//            if (empty($id_of_tag)) {
//                phonebook_set_vars_to_table(
//                    array(
//                        'tag' => $tag
//                    ), 'tags'
//                );
//                $id_of_tag = phonebook_get_id_of_tag('idt', 'tag', $tag);
//            }
//            $list_of_tags .= "$id_of_tag,";
//        }
//        $list_of_tags = substr($list_of_tags, 0, -1);
//        phonebook_set_vars_to_table(array(
//            'name' => $name,
//            'number' => $number,
//            'idtags' => $list_of_tags
//        ), 'phonebook'
//        );
//        drupal_set_message(t("The person called $name with phonenumber of $number was added to DB"), 'notice');
//    }
}

function phonebook_get_id_of_tag($input, $output, $condition)
{
    $id = db_select('tags', 't')
        ->fields('t', array("$input"))
        ->condition("t.$output", "$condition")
        ->execute()
        ->fetchObject();
    return $id ? $id->$input : '';
}

function phonebook_set_vars_to_table($vars = array(), $tablename)
{
    db_insert($tablename)
        ->fields($vars)
        ->execute();
}

function phonebook_get_phones_data() {
    $phones = db_select('phonebook', 'p')
        ->fields('p')
        ->condition('p.idp', 0, '>=')
        ->execute()
        ->fetchAll();
    return $phones ? $phones : '';
}

